<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌵 Kaktus Anzucht System Pro</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
            padding: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .tabs {
            display: flex;
            background: #f3f4f6;
            border-bottom: 2px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab {
            padding: 1rem 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e5e7eb;
        }

        .tab.active {
            background: white;
            color: #16a34a;
            border-bottom: 3px solid #16a34a;
        }

        .content {
            padding: 2rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .input, .select, .textarea {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .input:focus, .select:focus, .textarea:focus {
            outline: none;
            border-color: #16a34a;
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-right: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #16a34a;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #15803d;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-info {
            background: #3b82f6;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover:not(:disabled) {
            background: #7c3aed;
        }

        .btn-danger {
            background: #dc2626;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #b91c1c;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .table-container {
            overflow-x: auto;
            margin-top: 2rem;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: #f3f4f6;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background 0.2s;
        }

        .table th:hover {
            background: #e5e7eb;
        }

        .table th.sortable {
            padding-right: 2rem;
        }

        .sort-indicator {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.875rem;
            color: #6b7280;
            display: inline-flex;
            flex-direction: column;
            line-height: 0.5;
        }

        .sort-indicator.active-asc {
            color: #16a34a;
        }

        .sort-indicator.active-desc {
            color: #16a34a;
        }

        .sort-arrow {
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .sort-arrow.active {
            opacity: 1;
        }

        .table td {
            padding: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .table tr:hover {
            background: #f9fafb;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #16a34a;
        }

        .stat-label {
            color: #6b7280;
            margin-top: 0.5rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            border: 4px solid #e5e7eb;
            border-top: 4px solid #16a34a;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #fee2e2;
            border: 1px solid #fecaca;
            color: #991b1b;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .success {
            background: #dcfce7;
            border: 1px solid #bbf7d0;
            color: #166534;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .badge-success {
            background: #dcfce7;
            color: #166534;
        }

        .badge-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .badge-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-purple {
            background: #ede9fe;
            color: #6d28d9;
        }

        .info-box {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .care-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .care-card:hover {
            border-color: #16a34a;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .care-card h3 {
            color: #16a34a;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .care-item {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }

        .care-item:hover {
            background: #f3f4f6;
        }

        .care-item input[type="checkbox"] {
            margin-right: 1rem;
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .care-item-content {
            flex: 1;
        }

        .care-item-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .care-item-detail {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .care-priority {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .priority-high {
            background: #fee2e2;
            color: #991b1b;
        }

        .priority-medium {
            background: #fef3c7;
            color: #92400e;
        }

        .priority-low {
            background: #dcfce7;
            color: #166534;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal h2 {
            margin-bottom: 1.5rem;
            color: #1f2937;
        }

        .modal-buttons {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .date-info {
            display: inline-block;
            margin-left: 0.5rem;
            color: #6b7280;
            font-size: 0.875rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.75rem;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1;
                min-width: 100px;
                font-size: 0.875rem;
                padding: 0.75rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;

        const KaktusApp = () => {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [species, setSpecies] = useState([]);
            const [sowings, setSowings] = useState([]);
            const [plants, setPlants] = useState([]);
            const [diary, setDiary] = useState([]);
            const [loading, setLoading] = useState(true);
            const [saving, setSaving] = useState(false);
            const [error, setError] = useState(null);
            const [success, setSuccess] = useState(null);
            const [showGerminationModal, setShowGerminationModal] = useState(false);
            const [selectedSowing, setSelectedSowing] = useState(null);
            const [germinationData, setGerminationData] = useState({
                germination_date: new Date().toISOString().split('T')[0],
                germinated_count: ''
            });
            const [stats, setStats] = useState({
                overview: { total_species: 0, total_sowings: 0, total_plants: 0, total_diary_entries: 0 }
            });

            const [sortConfig, setSortConfig] = useState({
                species: { key: 'name', direction: 'asc' },
                sowings: { key: 'sowing_date', direction: 'desc' },
                plants: { key: 'plant_uid', direction: 'desc' },
                diary: { key: 'date', direction: 'desc' }
            });

            const [speciesForm, setSpeciesForm] = useState({ name: '', substrate: 'Mineralisch', temperature: '20-25°C', germination_time: '1-4 Wochen', care_notes: '' });
            const [sowingForm, setSowingForm] = useState({ species: '', sowing_date: new Date().toISOString().split('T')[0], seed_count: '', pot_number: '', notes: '' });
            const [plantForm, setPlantForm] = useState({ species: '', purchase_date: new Date().toISOString().split('T')[0], location: '', substrate: 'Mineralisch', notes: '' });
            const [diaryForm, setDiaryForm] = useState({ date: new Date().toISOString().split('T')[0], species: '', note: '', entry_type: 'general' });

            const handleSort = (tableName, key) => {
                let direction = 'asc';
                if (sortConfig[tableName].key === key && sortConfig[tableName].direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig(prev => ({ ...prev, [tableName]: { key, direction } }));
            };

            const sortData = (data, config) => {
                if (!config.key) return data;
                const sortedData = [...data].sort((a, b) => {
                    if (a[config.key] < b[config.key]) return config.direction === 'asc' ? -1 : 1;
                    if (a[config.key] > b[config.key]) return config.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                return sortedData;
            };

            const SortIndicator = ({ column, sortKey, sortDirection }) => {
                if (sortKey !== column) return null;
                return <span style={{ marginLeft: '5px' }}>{sortDirection === 'asc' ? '▲' : '▼'}</span>;
            };

            const showMessage = (type, message, duration = 4000) => {
                (type === 'error' ? setError : setSuccess)(message);
                setTimeout(() => (type === 'error' ? setError : setSuccess)(null), duration);
            };

            const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('de-DE') : '-';

            const loadData = async () => {
                setLoading(true);
                try {
                    const [speciesRes, sowingsRes, plantsRes, diaryRes, statsRes] = await Promise.all([
                        fetch('/api/species').then(r => r.json()),
                        fetch('/api/sowings').then(r => r.json()),
                        fetch('/api/plants').then(r => r.json()),
                        fetch('/api/diary').then(r => r.json()),
                        fetch('/api/dashboard-stats').then(r => r.json())
                    ]);
                    setSpecies(speciesRes || []);
                    setSowings(sowingsRes || []);
                    setPlants(plantsRes || []);
                    setDiary(diaryRes || []);
                    setStats(statsRes || { overview: {} });
                } catch (err) {
                    showMessage('error', 'Daten konnten nicht geladen werden.');
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            const addSpecies = async (e) => {
                e.preventDefault();
                if (!speciesForm.name.trim()) return showMessage('error', 'Name der Art fehlt.');
                setSaving(true);
                try {
                    const response = await fetch('/api/species', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(speciesForm) });
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error);
                    showMessage('success', 'Art hinzugefügt!');
                    setSpeciesForm({ name: '', substrate: 'Mineralisch', temperature: '20-25°C', germination_time: '1-4 Wochen', care_notes: '' });
                    loadData();
                } catch (err) {
                    showMessage('error', err.message);
                } finally {
                    setSaving(false);
                }
            };

            const addSowing = async (e) => {
                e.preventDefault();
                if (!sowingForm.species || !sowingForm.seed_count || !sowingForm.pot_number) return showMessage('error', 'Bitte alle Pflichtfelder ausfüllen.');
                setSaving(true);
                try {
                    await fetch('/api/sowings', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(sowingForm) });
                    showMessage('success', 'Aussaat hinzugefügt!');
                    setSowingForm({ species: '', sowing_date: new Date().toISOString().split('T')[0], seed_count: '', pot_number: '', notes: '' });
                    loadData();
                } catch (err) {
                    showMessage('error', 'Fehler beim Speichern.');
                } finally {
                    setSaving(false);
                }
            };

            const openGerminationModal = (sowing) => {
                setSelectedSowing(sowing);
                setGerminationData({ germination_date: new Date().toISOString().split('T')[0], germinated_count: sowing.seed_count });
                setShowGerminationModal(true);
            };

            const markAsGerminated = async () => {
                if (!germinationData.germinated_count || germinationData.germinated_count < 1) return showMessage('error', 'Anzahl gekeimter Samen eingeben.');
                setSaving(true);
                try {
                    await fetch(`/api/sowings/${selectedSowing.id}/germinate`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(germinationData) });

                    const plantData = {
                        species: selectedSowing.species,
                        purchase_date: germinationData.germination_date,
                        location: `Anzucht - Topf ${selectedSowing.pot_number}`,
                        substrate: 'Mineralisch (Anzucht)',
                        notes: `Aus Aussaat vom ${formatDate(selectedSowing.sowing_date)}. ${germinationData.germinated_count} von ${selectedSowing.seed_count} Samen gekeimt.`
                    };
                    await fetch('/api/plants', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(plantData) });

                    showMessage('success', 'Keimung markiert & Pflanze in Bestand übernommen!');
                    setShowGerminationModal(false);
                    loadData();
                } catch (err) {
                    showMessage('error', 'Fehler beim Speichern.');
                } finally {
                    setSaving(false);
                }
            };

            const addPlant = async (e) => {
                e.preventDefault();
                if (!plantForm.species) return showMessage('error', 'Bitte eine Art auswählen.');
                setSaving(true);
                try {
                    await fetch('/api/plants', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(plantForm) });
                    showMessage('success', 'Pflanze zum Bestand hinzugefügt!');
                    setPlantForm({ species: '', purchase_date: new Date().toISOString().split('T')[0], location: '', substrate: 'Mineralisch', notes: '' });
                    loadData();
                } catch (err) {
                    showMessage('error', 'Fehler beim Speichern.');
                } finally {
                    setSaving(false);
                }
            };

            const deletePlant = async (id, name) => {
                if (confirm(`Soll die Pflanze "${name}" wirklich gelöscht werden?`)) {
                    await fetch(`/api/plants/${id}`, { method: 'DELETE' });
                    showMessage('success', 'Pflanze gelöscht.');
                    loadData();
                }
            };

            const updatePlantCare = async (plantId, action) => {
                await fetch(`/api/plants/${plantId}`, { method: 'PATCH', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ [action]: true }) });
                showMessage('success', `Pflege-Aktion vermerkt.`);
                loadData();
            };

            const addDiaryEntry = async (e) => {
                e.preventDefault();
                if (!diaryForm.note.trim()) return showMessage('error', 'Bitte eine Notiz eingeben.');
                setSaving(true);
                try {
                    await fetch('/api/diary', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(diaryForm) });
                    showMessage('success', 'Eintrag gespeichert!');
                    setDiaryForm({ date: new Date().toISOString().split('T')[0], species: '', note: '', entry_type: 'general' });
                    loadData();
                } catch (err) {
                    showMessage('error', 'Fehler beim Speichern.');
                } finally {
                    setSaving(false);
                }
            };

            // ==================== RENDER FUNKTIONEN ====================

            const renderDashboard = () => (
                <div>
                    <div className="section-title">📊 Dashboard</div>
                    <div className="stats-grid">
                        <div className="stat-card"><div className="stat-value">{stats.overview.total_species}</div><div className="stat-label">Arten</div></div>
                        <div className="stat-card"><div className="stat-value">{stats.overview.total_sowings}</div><div className="stat-label">Aussaaten</div></div>
                        <div className="stat-card"><div className="stat-value">{stats.overview.total_plants}</div><div className="stat-label">Pflanzen</div></div>
                        <div className="stat-card"><div className="stat-value">{stats.overview.total_diary_entries}</div><div className="stat-label">Tagebucheinträge</div></div>
                    </div>
                </div>
            );

            const renderSpeciesTab = () => {
                const sortedSpecies = sortData(species, sortConfig.species);
                return (
                    <div>
                        <div className="section-title">🌵 Arten verwalten</div>
                        <form onSubmit={addSpecies}>
                            <div className="form-grid">
                                <div className="form-group"><label className="label">Name *</label><input type="text" className="input" value={speciesForm.name} onChange={e => setSpeciesForm({...speciesForm, name: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Substrat</label><input type="text" className="input" value={speciesForm.substrate} onChange={e => setSpeciesForm({...speciesForm, substrate: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Temperatur</label><input type="text" className="input" value={speciesForm.temperature} onChange={e => setSpeciesForm({...speciesForm, temperature: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Keimdauer</label><input type="text" className="input" value={speciesForm.germination_time} onChange={e => setSpeciesForm({...speciesForm, germination_time: e.target.value})} /></div>
                            </div>
                            <button type="submit" className="btn btn-primary" disabled={saving}>{saving ? 'Speichert...' : '➕ Art hinzufügen'}</button>
                        </form>
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th className="sortable" onClick={() => handleSort('species', 'name')}>Name <SortIndicator column="name" {...sortConfig.species} /></th>
                                        <th>Substrat</th><th>Temperatur</th><th>Keimdauer</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedSpecies.map(s => <tr key={s.id}><td><strong>{s.name}</strong></td><td>{s.substrate}</td><td>{s.temperature}</td><td>{s.germination_time}</td></tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderSowingsTab = () => {
                const sortedSowings = sortData(sowings, sortConfig.sowings);
                return (
                    <div>
                        <div className="section-title">🌱 Aussaat-Tracking</div>
                        <form onSubmit={addSowing}>
                            <div className="form-grid">
                                <div className="form-group"><label className="label">Art *</label><select className="select" value={sowingForm.species} onChange={e => setSowingForm({...sowingForm, species: e.target.value})}><option value="">-- Wählen --</option>{species.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                <div className="form-group"><label className="label">Aussaat-Datum</label><input type="date" className="input" value={sowingForm.sowing_date} onChange={e => setSowingForm({...sowingForm, sowing_date: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Anzahl Samen *</label><input type="number" className="input" value={sowingForm.seed_count} onChange={e => setSowingForm({...sowingForm, seed_count: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Topf Nr. *</label><input type="text" className="input" value={sowingForm.pot_number} onChange={e => setSowingForm({...sowingForm, pot_number: e.target.value})} /></div>
                            </div>
                            <button type="submit" className="btn btn-primary" disabled={saving}>{saving ? 'Speichert...' : '➕ Aussaat hinzufügen'}</button>
                        </form>
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th className="sortable" onClick={() => handleSort('sowings', 'species_name')}>Art <SortIndicator column="species_name" {...sortConfig.sowings} /></th>
                                        <th className="sortable" onClick={() => handleSort('sowings', 'sowing_date')}>Datum <SortIndicator column="sowing_date" {...sortConfig.sowings} /></th>
                                        <th>Topf</th><th>Samen</th><th>Status</th><th>Tage</th><th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedSowings.map(s => <tr key={s.id}>
                                        <td><strong>{s.species_name}</strong></td>
                                        <td>{formatDate(s.sowing_date)}</td>
                                        <td>{s.pot_number}</td>
                                        <td>{s.seed_count}</td>
                                        <td>{s.germinated ? <span className="badge badge-success">Gekeimt ({s.germinated_count}/{s.seed_count})</span> : <span className="badge badge-warning">Wartend</span>}</td>
                                        <td>{s.days_since_sowing}</td>
                                        <td>{!s.germinated && <button onClick={() => openGerminationModal(s)} className="btn btn-success btn-small">🌱 Gekeimt</button>}</td>
                                    </tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderPlantsTab = () => {
                const sortedPlants = sortData(plants, sortConfig.plants);
                return (
                    <div>
                        <div className="section-title">🌿 Pflanzenbestand</div>
                        <form onSubmit={addPlant}>
                            <div className="form-grid">
                                <div className="form-group"><label className="label">Art *</label><select className="select" value={plantForm.species} onChange={e => setPlantForm({...plantForm, species: e.target.value})}><option value="">-- Wählen --</option>{species.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                <div className="form-group"><label className="label">Kauf-/Erstelldatum</label><input type="date" className="input" value={plantForm.purchase_date} onChange={e => setPlantForm({...plantForm, purchase_date: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Standort</label><input type="text" className="input" value={plantForm.location} onChange={e => setPlantForm({...plantForm, location: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Substrat</label><input type="text" className="input" value={plantForm.substrate} onChange={e => setPlantForm({...plantForm, substrate: e.target.value})} /></div>
                            </div>
                            <button type="submit" className="btn btn-primary" disabled={saving}>{saving ? 'Speichert...' : '➕ Pflanze hinzufügen'}</button>
                        </form>
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th className="sortable" onClick={() => handleSort('plants', 'plant_uid')}>ID <SortIndicator column="plant_uid" {...sortConfig.plants} /></th>
                                        <th className="sortable" onClick={() => handleSort('plants', 'species_name')}>Art <SortIndicator column="species_name" {...sortConfig.plants} /></th>
                                        <th className="sortable" onClick={() => handleSort('plants', 'purchase_date')}>Datum <SortIndicator column="purchase_date" {...sortConfig.plants} /></th>
                                        <th>Standort</th>
                                        <th>Gegossen</th>
                                        <th>Aktionen</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedPlants.map(p => <tr key={p.id}>
                                        <td><strong>{p.plant_uid}</strong></td>
                                        <td><strong>{p.species_name}</strong></td>
                                        <td>{formatDate(p.purchase_date)}</td>
                                        <td>{p.location}</td>
                                        <td>{p.last_watered ? `${formatDate(p.last_watered)} (vor ${p.days_since_watering} T.)` : 'Nie'}</td>
                                        <td>
                                            <div className="btn-group">
                                                <button onClick={() => updatePlantCare(p.id, 'last_watered')} className="btn btn-info btn-small">💧</button>
                                                <button onClick={() => updatePlantCare(p.id, 'last_fertilized')} className="btn btn-warning btn-small">🧪</button>
                                                <button onClick={() => deletePlant(p.id, p.species_name)} className="btn btn-danger btn-small">🗑️</button>
                                            </div>
                                        </td>
                                    </tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            const renderDiaryTab = () => {
                const sortedDiary = sortData(diary, sortConfig.diary);
                return (
                    <div>
                        <div className="section-title">📔 Tagebuch</div>
                        <form onSubmit={addDiaryEntry}>
                            <div className="form-grid">
                                <div className="form-group"><label className="label">Datum</label><input type="date" className="input" value={diaryForm.date} onChange={e => setDiaryForm({...diaryForm, date: e.target.value})} /></div>
                                <div className="form-group"><label className="label">Art (optional)</label><select className="select" value={diaryForm.species} onChange={e => setDiaryForm({...diaryForm, species: e.target.value})}><option value="">-- Allgemein --</option>{species.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select></div>
                                <div className="form-group"><label className="label">Typ</label><select className="select" value={diaryForm.entry_type} onChange={e => setDiaryForm({...diaryForm, entry_type: e.target.value})}><option value="general">Allgemein</option><option value="watering">Gießen</option><option value="fertilizing">Düngung</option><option value="repotting">Umtopfen</option></select></div>
                            </div>
                            <div className="form-group"><label className="label">Notiz *</label><textarea className="textarea" value={diaryForm.note} onChange={e => setDiaryForm({...diaryForm, note: e.target.value})}></textarea></div>
                            <button type="submit" className="btn btn-primary" disabled={saving}>{saving ? 'Speichert...' : '➕ Eintrag hinzufügen'}</button>
                        </form>
                        <div className="table-container">
                            <table className="table">
                                <thead>
                                    <tr>
                                        <th className="sortable" onClick={() => handleSort('diary', 'date')}>Datum <SortIndicator column="date" {...sortConfig.diary} /></th>
                                        <th>Art</th><th>Typ</th><th>Notiz</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {sortedDiary.map(e => <tr key={e.id}>
                                        <td>{formatDate(e.date)}</td>
                                        <td>{e.species_name || 'Allgemein'}</td>
                                        <td><span className={`badge badge-${e.entry_type === 'general' ? 'success' : 'info'}`}>{e.entry_type}</span></td>
                                        <td>{e.note}</td>
                                    </tr>)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

             const renderExportTab = () => (
                <div>
                    <div className="section-title">📥 Daten exportieren</div>
                    <div className="info-box" style={{textAlign: 'center'}}>
                        <h3>Export als ZIP-Datei</h3>
                        <p style={{margin: '1rem 0'}}>Exportiert alle Ihre Daten als CSV-Dateien.</p>
                        <button onClick={() => window.location.href = '/api/export/all'} className="btn btn-primary">📦 Alles exportieren</button>
                    </div>
                </div>
            );

            return (
                <div className="container">
                    <div className="card">
                        <div className="header"><h1>🌵 Kaktus Anzucht System</h1><p>Professionelles Tracking für Ihre Kakteen</p></div>
                        <div className="tabs">
                            <button className={`tab ${activeTab === 'dashboard' ? 'active' : ''}`} onClick={() => setActiveTab('dashboard')}>📊 Dashboard</button>
                            <button className={`tab ${activeTab === 'species' ? 'active' : ''}`} onClick={() => setActiveTab('species')}>🌵 Arten</button>
                            <button className={`tab ${activeTab === 'sowings' ? 'active' : ''}`} onClick={() => setActiveTab('sowings')}>🌱 Aussaat</button>
                            <button className={`tab ${activeTab === 'plants' ? 'active' : ''}`} onClick={() => setActiveTab('plants')}>🌿 Bestand</button>
                            <button className={`tab ${activeTab === 'diary' ? 'active' : ''}`} onClick={() => setActiveTab('diary')}>📔 Tagebuch</button>
                            <button className={`tab ${activeTab === 'export' ? 'active' : ''}`} onClick={() => setActiveTab('export')}>📥 Export</button>
                        </div>
                        <div className="content">
                            {error && <div className="error">❌ {error}</div>}
                            {success && <div className="success">✅ {success}</div>}
                            {loading ? <div className="loading"><div className="spinner"></div>Lade Daten...</div> : (
                                <>
                                    {activeTab === 'dashboard' && renderDashboard()}
                                    {activeTab === 'species' && renderSpeciesTab()}
                                    {activeTab === 'sowings' && renderSowingsTab()}
                                    {activeTab === 'plants' && renderPlantsTab()}
                                    {activeTab === 'diary' && renderDiaryTab()}
                                    {activeTab === 'export' && renderExportTab()}
                                </>
                            )}
                        </div>
                    </div>
                     {showGerminationModal && (
                        <div className="modal-overlay">
                            <div className="modal">
                                <h2>🌱 Keimung markieren</h2>
                                <p><strong>{selectedSowing?.species_name}</strong> - Topf {selectedSowing?.pot_number}</p>
                                <div className="form-group">
                                    <label className="label">Keim-Datum</label>
                                    <input type="date" className="input" value={germinationData.germination_date} onChange={(e) => setGerminationData({...germinationData, germination_date: e.target.value})} />
                                </div>
                                <div className="form-group">
                                    <label className="label">Anzahl gekeimter Samen (von {selectedSowing?.seed_count})</label>
                                    <input type="number" className="input" value={germinationData.germinated_count} onChange={(e) => setGerminationData({...germinationData, germinated_count: e.target.value})} />
                                </div>
                                <div className="modal-buttons">
                                    <button className="btn btn-secondary" onClick={() => setShowGerminationModal(false)} disabled={saving}>Abbrechen</button>
                                    <button className="btn btn-success" onClick={markAsGerminated} disabled={saving}>{saving ? 'Speichert...' : 'Bestätigen'}</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.render(<KaktusApp />, document.getElementById('root'));
    </script>
</body>
</html>
